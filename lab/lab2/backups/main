#!/bin/bash

#--------------------------------------------------------------------------------------
#â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘â–ˆâ–ˆâ•—â–‘â–‘â–ˆâ–ˆâ•—â€ƒâ€ƒâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘â–ˆâ–ˆâ–ˆâ•—â–‘â–‘â–‘â–ˆâ–ˆâ–ˆâ•—
#â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–‘â–ˆâ–ˆâ•”â•â€ƒâ€ƒâ–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â•â•â–‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ•—â–‘â–ˆâ–ˆâ–ˆâ–ˆâ•‘
#â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•¦â•â–ˆâ–ˆâ•‘â–‘â–‘â•šâ•â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•â•â–‘â€ƒâ€ƒâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–‘â–‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–‘â–‘â–ˆâ–ˆâ•—â–‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ–ˆâ–ˆâ•”â–ˆâ–ˆâ•‘
#â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–‘â–‘â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•—â–‘â€ƒâ€ƒâ–ˆâ–ˆâ•”â•â•â•â•â–‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–‘â–‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–‘â–‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘
#â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•¦â•â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–‘â•šâ–ˆâ–ˆâ•—â€ƒâ€ƒâ–ˆâ–ˆâ•‘â–‘â–‘â–‘â–‘â–‘â–ˆâ–ˆâ•‘â–‘â–‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–‘â–‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–‘â–‘â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â–‘â•šâ•â•â–‘â–ˆâ–ˆâ•‘
#â•šâ•â•â•â•â•â•â–‘â–‘â•šâ•â•â•â•â•â–‘â•šâ•â•â–‘â–‘â•šâ•â•â€ƒâ€ƒâ•šâ•â•â–‘â–‘â–‘â–‘â–‘â•šâ•â•â–‘â–‘â•šâ•â•â–‘â•šâ•â•â•â•â•â–‘â–‘â•šâ•â•â•â•â•â•â–‘â•šâ•â•â–‘â–‘â•šâ•â•â•šâ•â•â–‘â–‘â•šâ•â•â•šâ•â•â–‘â–‘â–‘â–‘â–‘â•šâ•â•
#--------------------------------------------------------------------------------------

# Programa principal de copias de seguridad de archivos de configuraciÃ³n, archivos o directorio.
# Gestionados en la carpeta central /bck.
# Sustituyendo los archivos principales por enlaces simbÃ³licos

# Sistema BCK consta de 2 partes:
# - Una estructura de archivos donde se organizan las copias de los archivos
# - Un conjunto de programas de utilidad que gestionan la estructura de archivos

# Cuando se aÃ±ade un ficherom refiriÃ©ndose a ficheros o directorios en general, a este se le asocia un identificador. (ID) 
# Este id indica al fichero de forma unÃ­voca en el sistema y permite su  gestiÃ³n. El sistema bck permite:
#
# 1) AÃ±adir fichero a la copia (bcklink)
# 2) Ver los ids y ficheros asociados (bckview)
# 3) Modificar su id (bckmv)
# 4) Restaurar el fichero (bckrestore)
# 5) Eliminar el fichero de la copia (bckrm)

## Estructura de archivos
# . ~
# |
# |-+ bckdir/
#   |-- files/ ( contiene los archivos que se han incluido en bck, pero se sustituye el nombre del fichero por el del id asignado.)
#   |-- mypaths.txt ( contiene en cada lÃ­nea una pareja id,ruta (separada por una coma) 

# La forma en que funciona bck es sustituyendo el archivo original por un enlace
# simbÃ³lico que apunta a la copia realizada (el archivo dentro de la carpeta files
# nombrado por su id).
#
# Ejemplo:
#----------------------------------------------------------------
#                               Fichero original
#----------------------------------------------------------------
# ~/dir/test/$ ls -l
# -rw-rw-r-- 1 user 10 feb 10 18:52 file1.txt
# 
#
#----------------------------------------------------------------
#                         Fichero tras realizar copia
#----------------------------------------------------------------
# lrwxrwxrwx 1 user 52 feb 10 20:10 file1.txt -> /home/user/bckdir/files/f1
#
#----------------------------------------------------------------
#                               En mypaths.txt 
#----------------------------------------------------------------
# f1,/home//dir/test/file1.txt
#
#----------------------------------------------------------------
#                                   En 'files'
#----------------------------------------------------------------
# ~/bckdir/files/$ ls -l
# -rw-rw-r-- 1 user 13 mar 10 18:52 f1


# FunciÃ³n para imprimir el menÃº
print_menu() {
    echo -e "Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·"
    echo -e "\n>>>>>>>>>>>>> ÃŸğ“¬Æ™ ÏÉ¾ÏƒÖÉ¾Î±ğ“¶ <<<<<<<<<<<<\n"
    echo -e "Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·Â·"
    echo -e "\n\033[1;36m-- Menu de Copia de Seguridad --\n\033[0m"
    echo -e "\033[1;32m  1) AÃ±adir fichero a la copia (bcklink) \033[0m"
    echo -e "\033[1;32m  2) Ver los ids y ficheros asociados (bckview) \033[0m"
    echo -e "\033[1;32m  3) Modificar su id (bckmv) \033[0m"
    echo -e "\033[1;32m  4) Restaurar el fichero (bckrestore) \033[0m"
    echo -e "\033[1;32m  5) Eliminar el fichero de la copia (bckrm) \033[0m"
    echo -e "\033[1;35m  0) Salir \033[0m"
}

# FunciÃ³n para registrar los resultados en el archivo de log con fecha
log_result() {
    logs_dir="logs"
    # Verificar si el directorio logs/ existe, si no, crearlo
    if [ ! -d $logs_dir ]; then
        mkdir $logs_dir
    fi
    echo "$(date '+%Y-%m-%d %H:%M:%S') - $1" >> logs/"$(date +"%Y-%m-%d").log" 2>&1
}

# FunciÃ³n para salir del programa
exit_program() {
    echo ""
    echo -e "\033[1; 36m-- Gracias por usar el sistema BCK --\033[0m"
    echo "Finalizando el sistema BCK"
    sleep 2
    clear
}

# FunciÃ³n invÃ¡lida en el sistema BCK
bad_option() {
    echo ""
    echo -e "\033[1;31m -- \t Illegal options --\033[0m"
    echo -e "\033[1;31m Vuelva a intentarlo de nuevo \033[0m"
    echo ""
}

# FunciÃ³n para ejecutar la opcion seleccionada
execute_option() {
    archivo_log="logs/$(date +"%Y-%m-%d").log"    
    case $option in
        1) ./functions/bcklink 2>&1 | tee -a $archivo_log;;
        2) ./functions/bckview 2>&1 | tee -a $archivo_log;;
        3) ./functions/bckmv 2>&1 | tee -a $archivo_log;;
        4) ./functions/bckrestore 2>&1 | tee -a $archivo_log;;
        5) ./functions/bckrm 2>&1 | tee -a $archivo_log;;
        0) exit_program 2>&1 | tee -a $archivo_log; exit;;
        *) bad_option 2>&1 | tee -a $archivo_log;;
    esac
}

# FunciÃ³n principal del script
main() {
    archivo_log="logs/$(date +"%Y-%m-%d").log"    
    while true; do
        clear
        print_menu
        read -p "   Ingrese una opcion: " option
        log_result "OpciÃ³n seleccionada: $option"        
        execute_option $option        
        read -p "Presione ENTER para continuar ..." backmenu
    done
}

# Ejecutar la funciÃ³n principal
main 